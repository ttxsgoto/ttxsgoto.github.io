
 <!DOCTYPE HTML>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  
    <title>Kubernetes Pods | ttxsgoto&#39; Blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=3, minimum-scale=1">
    
    <meta name="author" content="ttxsgoto">
    
    <meta name="description" content="容器内获取pod信息
环境变量，将pod信息注入为环境变量
123456789env：  - name: POD_NAME    valueFrom:      fieldRef:        fieldPath: metadata.name  - name: POD_NAMESPACE    v">
    
    
    
    
    
    
    <link rel="apple-touch-icon" href="/img/1.png">
    <link rel="apple-touch-icon-precomposed" href="/img/1.png">
    

  
    <link href="/css/font-awesome.min.css" rel="stylesheet">
    
  

    <link rel="stylesheet" href="/css/style.css">
    <script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?d182ed77fc48758bf45a33835ee35745";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

      <script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v1/st.js','_st');

  _st('install','.............Add your swiftype userID...............');
</script>
</head>

  <body>
    <header>
      <div>
		
			<div id="textlogo">
				<h1 class="site-name"><a href="/" title="ttxsgoto&#39; Blog">ttxsgoto&#39; Blog</a></h1>
				<h2 class="blog-motto">好好学习 努力工作 享受生活</h2>
			</div>
			<div class="navbar"><a class="navbutton navmobile" href="#" title="菜单">
			</a></div>
			<nav class="animated">
				<ul>
                    <ul>
					 
						<li><a href="/">首页</a></li>
					
						<li><a href="/archives">归档</a></li>
					
						<li><a href="/about">About</a></li>
					
					<li>
					
						<form class="search" action="/search/index.html" method="get" accept-charset="utf-8">
						<label>Search</label>
						<input type="text" id="st-search-inpu" maxlength="20" placeholder="Search" />
						</form>
					
					</li>
                <!--<li><div class="closeaside"><a class="closebutton" href="#" title="隐藏侧边栏"></a></div></li>-->

				</ul>
			</nav>	
</div>
    </header>
    <div id="container" class="clearfix">
      <div id="main" class="post" itemscope itemprop="blogPost">
	<article itemprop="articleBody"> 
		<header class="article-info clearfix">
  <h1 itemprop="name">
    
      <a href="/2020/03/20/k8s-pods/" title="Kubernetes Pods" itemprop="url">Kubernetes Pods</a>
  </h1>
  <p class="article-time">
    <time datetime="2020-03-20T09:40:23.000Z" itemprop="datePublished">2020-03-20</time>
  </p>
</header>
	<div class="article-content">
		
		
		<div id="toc" class="toc-article">
			<strong class="toc-title"></strong>
		<ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#容器内获取pod信息"><span class="toc-number">1.</span> <span class="toc-text">容器内获取pod信息</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod生命周期和重启策略"><span class="toc-number">2.</span> <span class="toc-text">Pod生命周期和重启策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#生命周期"><span class="toc-number">2.1.</span> <span class="toc-text">生命周期</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#重启策略"><span class="toc-number">2.2.</span> <span class="toc-text">重启策略</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#健康检查和服务可用性检查"><span class="toc-number">3.</span> <span class="toc-text">健康检查和服务可用性检查</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#LivenessProbe探针"><span class="toc-number">3.1.</span> <span class="toc-text">LivenessProbe探针</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ReadinessProbe探针"><span class="toc-number">3.2.</span> <span class="toc-text">ReadinessProbe探针</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#调度策略"><span class="toc-number">4.</span> <span class="toc-text">调度策略</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#NodeSelector"><span class="toc-number">4.1.</span> <span class="toc-text">NodeSelector</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#NodeAffinity亲和性调度"><span class="toc-number">4.2.</span> <span class="toc-text">NodeAffinity亲和性调度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#PodAffinity亲和性调度"><span class="toc-number">4.3.</span> <span class="toc-text">PodAffinity亲和性调度</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Taints-and-Tolerations-污点和容忍"><span class="toc-number">4.4.</span> <span class="toc-text">Taints and Tolerations 污点和容忍</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod调度"><span class="toc-number">5.</span> <span class="toc-text">Pod调度</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#RC-amp-Deployment"><span class="toc-number">5.1.</span> <span class="toc-text">RC & Deployment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#DaemonSet"><span class="toc-number">5.2.</span> <span class="toc-text">DaemonSet</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Job"><span class="toc-number">5.3.</span> <span class="toc-text">Job</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Cronjob"><span class="toc-number">5.4.</span> <span class="toc-text">Cronjob</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Init-Container-初始化容器"><span class="toc-number">6.</span> <span class="toc-text">Init Container 初始化容器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod升级和回滚"><span class="toc-number">7.</span> <span class="toc-text">Pod升级和回滚</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Deployment-升级和回滚"><span class="toc-number">7.1.</span> <span class="toc-text">Deployment 升级和回滚</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#暂停和恢复Deployment部署"><span class="toc-number">7.2.</span> <span class="toc-text">暂停和恢复Deployment部署</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Pod的扩缩容"><span class="toc-number">8.</span> <span class="toc-text">Pod的扩缩容</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#手动扩缩容机制"><span class="toc-number">8.1.</span> <span class="toc-text">手动扩缩容机制</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#ConfigMap"><span class="toc-number">9.</span> <span class="toc-text">ConfigMap</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#使用场景"><span class="toc-number">9.1.</span> <span class="toc-text">使用场景</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#定义方式"><span class="toc-number">9.2.</span> <span class="toc-text">定义方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#使用方式"><span class="toc-number">9.3.</span> <span class="toc-text">使用方式</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ConfigMap的限制条件"><span class="toc-number">9.4.</span> <span class="toc-text">ConfigMap的限制条件</span></a></li></ol></li></ol>
		</div>
		
		<h3 id="容器内获取pod信息"><a href="#容器内获取pod信息" class="headerlink" title="容器内获取pod信息"></a>容器内获取pod信息</h3><ul>
<li><p>环境变量，将pod信息注入为环境变量</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">env：</div><div class="line">  - name: POD_NAME</div><div class="line">    valueFrom:</div><div class="line">      fieldRef:</div><div class="line">        fieldPath: metadata.name</div><div class="line">  - name: POD_NAMESPACE</div><div class="line">    valueFrom:</div><div class="line">      fieldRef:</div><div class="line">        fieldPath: metadata.namespace</div></pre></td></tr></table></figure>
</li>
<li><p>Volume挂载方式,类似于环境变量，只是将数据保存为文件并挂载到内部</p>
</li>
</ul>
<h3 id="Pod生命周期和重启策略"><a href="#Pod生命周期和重启策略" class="headerlink" title="Pod生命周期和重启策略"></a>Pod生命周期和重启策略</h3><h4 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h4><ul>
<li>Pending 已创建pod，但还其中容器一个容器镜像还没有创建</li>
<li>Running Pod内所有容器都创建，且至少有一个容器处于运行状态</li>
<li>Successed Pod中所有容器均成功执行并退出，且不会再重启</li>
<li>Failed Pod内所有容器都已退出，单至少有一个容器退出为失败状态</li>
<li>Unknown 无法获取该Pod的状态</li>
</ul>
<h4 id="重启策略"><a href="#重启策略" class="headerlink" title="重启策略"></a>重启策略</h4><ul>
<li>Always 默认，当容器失效时，kubelet自动重启该容器</li>
<li>OnFailure 容器终止运行且退出码不为0，kubelet自动重启该容器</li>
<li>Never 无论容器运行状态如何，kubelet都不会重启容器</li>
</ul>
<p>kubelet重启失效容器的时间间隔以sync-frequency乘以2n，如1，2，4，8倍，最长延时5min，并在成功重启后10min后重置该时间</p>
<p>每种控制器对pod的重启策略要去如下：</p>
<ul>
<li>RC和DaemonSet 必须设置为always，需要保证该容器持续运行</li>
<li>Job OnFailure或者Never，确保容器执行完成后不再重启</li>
<li>kubelet 在pod失效时自动重启，不论将RestartPolicy设置为什么值，都不会对pod进行健康检查</li>
</ul>
<h3 id="健康检查和服务可用性检查"><a href="#健康检查和服务可用性检查" class="headerlink" title="健康检查和服务可用性检查"></a>健康检查和服务可用性检查</h3><h4 id="LivenessProbe探针"><a href="#LivenessProbe探针" class="headerlink" title="LivenessProbe探针"></a>LivenessProbe探针</h4><p>判断容器是否存活，如果探针探测到容器不健康，则会kill掉容器。如果不包含该探针，则该容器的LivenessProbe探针返回值永远是Success</p>
<h4 id="ReadinessProbe探针"><a href="#ReadinessProbe探针" class="headerlink" title="ReadinessProbe探针"></a>ReadinessProbe探针</h4><p>判断容器服务是否可用(Ready状态)，达到Ready状态的Pod才可以接收请求</p>
<ul>
<li>ExecAction 执行命令</li>
<li>TCPSocketAction socket的ip和端口检查</li>
<li>HTTPGetAction 调用http get方法状态码大于等于200且小于400，正常  <figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">- initialDelaySeconds 启动容器后进行首次检查的等待时间，单位为s</div><div class="line">- timeoutSeconds 健康检查发送请求后等待响应的超时时间，单位为s</div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="调度策略"><a href="#调度策略" class="headerlink" title="调度策略"></a>调度策略</h3><h4 id="NodeSelector"><a href="#NodeSelector" class="headerlink" title="NodeSelector"></a>NodeSelector</h4><p>通过node标签和pod的nodeselector属性匹配来定向调到到某个node节点上</p>
<h4 id="NodeAffinity亲和性调度"><a href="#NodeAffinity亲和性调度" class="headerlink" title="NodeAffinity亲和性调度"></a>NodeAffinity亲和性调度</h4><p>硬亲和requiredDuringSchedulingIgnoredDuringExecution 必须满足指定的规则才可以调度pod到node上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: pod-nodeaffinity</div><div class="line">  namespace: default</div><div class="line">  labels:</div><div class="line">   app: myapp-nodeselector</div><div class="line">   tier: frontend</div><div class="line">  annotations:</div><div class="line">    created-by: <span class="string">"ttxsgoto"</span></div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">  - name: myapp</div><div class="line">    image: ikubernetes/myapp:v1</div><div class="line">  affinity:</div><div class="line">    nodeAffinity:</div><div class="line">      requiredDuringSchedulingIgnoredDuringExecution:	<span class="comment"># 硬亲和性</span></div><div class="line">        nodeSelectorTerms:</div><div class="line">        - matchExpressions:</div><div class="line">          - key: zone</div><div class="line">            operator: In</div><div class="line">            values:</div><div class="line">            - foo</div><div class="line">            - bar</div></pre></td></tr></table></figure></p>
<p>软亲和preferredDuringSchedulingIgnoredDuringExecution 强调优先满足指定规则，则尝试调到pod到node，但如果没有满足条件，也调度到node，不强制限制<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: pod-nodeaffinity2</div><div class="line">  namespace: default</div><div class="line">  labels:</div><div class="line">   app: myapp-nodeselector</div><div class="line">   tier: frontend</div><div class="line">  annotations:</div><div class="line">    created-by: <span class="string">"ttxsgoto"</span></div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">  - name: myapp</div><div class="line">    image: ikubernetes/myapp:v1</div><div class="line">  affinity:</div><div class="line">    nodeAffinity:</div><div class="line">      preferredDuringSchedulingIgnoredDuringExecution:	<span class="comment"># 软亲和性</span></div><div class="line">      - preference:</div><div class="line">          matchExpressions:</div><div class="line">          - key: zone</div><div class="line">            operator: In</div><div class="line">            values:</div><div class="line">            - foo</div><div class="line">            - bar</div><div class="line">        weight: 60</div></pre></td></tr></table></figure></p>
<p><strong>说明</strong></p>
<ol>
<li>如果同时定义了nodeSelector和nodeAffinty，那么必须满足两个条件，pod才能运行在指定的node上</li>
<li>如果nodeAffinity指定了多个nodeSelectorTerms，那么其中一个能够匹配成功即可</li>
<li>如果nodeSelectorTerms中有多个matchExpressions，则一个节点必须满足所有的matchExpressions才能运行该Pod</li>
</ol>
<h4 id="PodAffinity亲和性调度"><a href="#PodAffinity亲和性调度" class="headerlink" title="PodAffinity亲和性调度"></a>PodAffinity亲和性调度</h4><p>根据在节点上正在运行的pod的标签来判断调度，要求对节点和Pod两个条件进行匹配， 第一个pod启动，其他的pod也在该node启动</p>
<p>requiredDuringSchedulingIgnoredDuringExecution  必须满足指定的规则才可以调度pod到node上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: pod-first</div><div class="line">  namespace: default</div><div class="line">  labels:</div><div class="line">   app: myapp-nodeselector</div><div class="line">   tier: frontend</div><div class="line">  annotations:</div><div class="line">    created-by: <span class="string">"ttxsgoto"</span></div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">  - name: myapp</div><div class="line">    image: ikubernetes/myapp:v1</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: pod-second</div><div class="line">  namespace: default</div><div class="line">  labels:</div><div class="line">   app: myapp-db</div><div class="line">   tier: db</div><div class="line">  annotations:</div><div class="line">    created-by: <span class="string">"ttxsgoto"</span></div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">  - name: busybox</div><div class="line">    image: busybox:latest</div><div class="line">    imagePullPolicy: IfNotPresent</div><div class="line">    <span class="built_in">command</span>: [<span class="string">"sh"</span>, <span class="string">"-c"</span>, <span class="string">"sleep 3600"</span>]</div><div class="line">  affinity:</div><div class="line">    podAffinity:</div><div class="line">      requiredDuringSchedulingIgnoredDuringExecution:</div><div class="line">      - labelSelector:</div><div class="line">          matchExpressions:</div><div class="line">          - &#123;key: app, operator: In, values: [<span class="string">"myapp-nodeselector"</span>]&#125;</div><div class="line">        topologyKey: kubernetes.io/hostname</div></pre></td></tr></table></figure></p>
<p>反亲和性<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: pod-first</div><div class="line">  namespace: default</div><div class="line">  labels:</div><div class="line">   app: myapp-nodeselector</div><div class="line">   tier: frontend</div><div class="line">  annotations:</div><div class="line">    created-by: <span class="string">"ttxsgoto"</span></div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">  - name: myapp</div><div class="line">    image: ikubernetes/myapp:v1</div><div class="line">---</div><div class="line">apiVersion: v1</div><div class="line">kind: Pod</div><div class="line">metadata:</div><div class="line">  name: pod-second</div><div class="line">  namespace: default</div><div class="line">  labels:</div><div class="line">   app: myapp-db</div><div class="line">   tier: db</div><div class="line">  annotations:</div><div class="line">    created-by: <span class="string">"ttxsgoto"</span></div><div class="line">spec:</div><div class="line">  containers:</div><div class="line">  - name: busybox</div><div class="line">    image: busybox:latest</div><div class="line">    imagePullPolicy: IfNotPresent</div><div class="line">    <span class="built_in">command</span>: [<span class="string">"sh"</span>, <span class="string">"-c"</span>, <span class="string">"sleep 3600"</span>]</div><div class="line">  affinity:</div><div class="line">    podAntiAffinity:</div><div class="line">      requiredDuringSchedulingIgnoredDuringExecution:</div><div class="line">      - labelSelector:</div><div class="line">          matchExpressions:</div><div class="line">          - &#123;key: app, operator: In, values: [<span class="string">"myapp-nodeselector"</span>]&#125;</div><div class="line">        topologyKey: kubernetes.io/hostname</div></pre></td></tr></table></figure></p>
<h4 id="Taints-and-Tolerations-污点和容忍"><a href="#Taints-and-Tolerations-污点和容忍" class="headerlink" title="Taints and Tolerations 污点和容忍"></a>Taints and Tolerations 污点和容忍</h4><p>让Node拒绝Pod的运行，让Pod避开那些不合适的Node，除非pod明确声明能够容忍这些污点，否则无法在这些node上运行</p>
<ul>
<li>NoSchedule 仅影响调度过程，对已启动的Pod对象不产生影响，明确声明可以容忍这个taint，否则就不会调度到该node上</li>
<li>PreferNoSchedule 既影响调度过程，也影响现有的Pod对象，意思为优先，没有对应的node可以运行，也可以调度到node， 可以为NoSchedule的软限制</li>
<li>NoExecute 即影响调度过程，也影响现在的pod对象，Pod已经在该节点运行，则会被驱逐，如果没有在该节点上运行，则不会再被调度到该节点上</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 设置Node上 Taint信息</span></div><div class="line">kubectl taint nodes node1 key=value:NoSchedule</div><div class="line"> </div><div class="line"><span class="comment"># pod中声明Toleration</span></div><div class="line">tolerations:</div><div class="line">- key: <span class="string">"key"</span></div><div class="line">  operator: <span class="string">"Equal"</span></div><div class="line">  value: <span class="string">"value1"</span></div><div class="line">  effect: <span class="string">"NoSchedule"</span></div><div class="line">或者</div><div class="line">tolerations:</div><div class="line">- key: <span class="string">"key"</span></div><div class="line">  operator: <span class="string">"Exists"</span></div><div class="line">  effect: <span class="string">"NoSchedule"</span> </div><div class="line"> </div><div class="line">说明：</div><div class="line">- 如果不指定operator，默认为Equal</div><div class="line">- 空的key配合Exists操作符能够匹配所有的键和值</div><div class="line">- 空的effect匹配所有的effect</div></pre></td></tr></table></figure>
<h3 id="Pod调度"><a href="#Pod调度" class="headerlink" title="Pod调度"></a>Pod调度</h3><ul>
<li>RC &amp; Deployment</li>
<li>DaemonSet</li>
<li>Job</li>
<li>Cronjob</li>
</ul>
<h4 id="RC-amp-Deployment"><a href="#RC-amp-Deployment" class="headerlink" title="RC &amp; Deployment"></a>RC &amp; Deployment</h4><p>自动部署一个容器的多个副本，以及持续监控副本的数量，在集群内始终维持指定的副本数量<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">apiVersion: apps/v1</div><div class="line"><span class="comment">#apiVersion: apps/v1beta1</span></div><div class="line">kind: Deployment</div><div class="line">metadata:</div><div class="line">  name: nginx-deployment</div><div class="line">spec:</div><div class="line">  selector:</div><div class="line">    matchLabels:</div><div class="line">      app: nginx</div><div class="line">  replicas: 3</div><div class="line">  template:</div><div class="line">    metadata:</div><div class="line">      labels:</div><div class="line">        app: nginx</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: nginx</div><div class="line">        image: nginx:1.7.9</div><div class="line">        ports:</div><div class="line">        - containerPort: 80</div></pre></td></tr></table></figure></p>
<h4 id="DaemonSet"><a href="#DaemonSet" class="headerlink" title="DaemonSet"></a>DaemonSet</h4><ul>
<li>在每个node上都调度一个pod，适用于监控系统，数据采集等资源的采集</li>
<li>新加入的node也同样会自动运行一个pod</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"></div></pre></td></tr></table></figure>
<h4 id="Job"><a href="#Job" class="headerlink" title="Job"></a>Job</h4><p>批处理调度,仅执行一次的任务，保证处理任务的一个或者多个pod成功结束<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">apiVersion: batch/v1</div><div class="line">kind: Job</div><div class="line">metadata:</div><div class="line">  name: k8s-job</div><div class="line">spec:</div><div class="line">  template:</div><div class="line">    spec:</div><div class="line">      containers:</div><div class="line">      - name: python</div><div class="line">        image: python:3.8-alpine</div><div class="line">        <span class="built_in">command</span>: [<span class="string">"python"</span>, <span class="string">"-c"</span>, <span class="string">"import socket; print(socket.gethostbyname(socket.gethostname()))"</span>]</div><div class="line">      restartPolicy: Never</div><div class="line">  backoffLimit: 4</div></pre></td></tr></table></figure></p>
<h4 id="Cronjob"><a href="#Cronjob" class="headerlink" title="Cronjob"></a>Cronjob</h4><ul>
<li>在给定时间点只运行一次</li>
<li>周期性地给定时间点运行</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">apiVersion: batch/v1beta1</div><div class="line">kind: CronJob</div><div class="line">metadata:</div><div class="line">  name: k8s-cronjob</div><div class="line">spec:</div><div class="line">  schedule: <span class="string">"*/1 * * * *"</span></div><div class="line">  jobTemplate:</div><div class="line">    spec:</div><div class="line">      template:</div><div class="line">        spec:</div><div class="line">          containers:</div><div class="line">          - name: python</div><div class="line">            image: python:3.8-alpine</div><div class="line">            <span class="built_in">command</span>: [<span class="string">"python"</span>, <span class="string">"-c"</span>, <span class="string">"import socket; print(socket.gethostbyname(socket.gethostname()))"</span>]</div><div class="line">          restartPolicy: OnFailure</div></pre></td></tr></table></figure>
<h3 id="Init-Container-初始化容器"><a href="#Init-Container-初始化容器" class="headerlink" title="Init Container 初始化容器"></a>Init Container 初始化容器</h3><p>应用场景</p>
<ul>
<li>等待其他关联组件正确运行</li>
<li>基于环境变量或者配置模板生成配置文件</li>
<li>从远程数据库中获取本地所需配置，或者自身注册到某个中央数据库中</li>
<li>下载相关依赖包，或者对系统进行一些预配置</li>
</ul>
<p>init Container和应用容器的区别：</p>
<ul>
<li>先于应用容器执行，如果设置多个init container，按顺序运行，并且当前一个init container运行成功后，在运行下一个，所有都运行成功后，才会运行应用容器</li>
<li>在init container的定义中也可以设置资源限制，volume的使用</li>
<li>如果多个init container都定义了资源请求，则取最大的值作为所有init container的资源请求值/资源限制值</li>
<li>调度算法将基于pod的有效资源请求值/资源限制值进行计算</li>
<li>init container不能设置readinessProbe探针</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">initContainers:</div><div class="line">- name: install</div><div class="line">  image: busybox</div><div class="line">  command:</div><div class="line">  - &quot;sh&quot;</div><div class="line">  - &quot;-c&quot;</div><div class="line">  - &quot;ls&quot;</div></pre></td></tr></table></figure>
<h3 id="Pod升级和回滚"><a href="#Pod升级和回滚" class="headerlink" title="Pod升级和回滚"></a>Pod升级和回滚</h3><h4 id="Deployment-升级和回滚"><a href="#Deployment-升级和回滚" class="headerlink" title="Deployment 升级和回滚"></a>Deployment 升级和回滚</h4><ul>
<li>deployment升级镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">kubectl set image deployment/nginx-deployment nginx=nginx:1.9.1</div><div class="line">或者</div><div class="line">kubectl edit deployment/nginx-deployment</div><div class="line">  </div><div class="line"># 查看升级状态</div><div class="line">kubectl rollout status deployment/nginx-deployment</div><div class="line"># 查看rs状态</div><div class="line">kubectl get rs</div></pre></td></tr></table></figure>
<p>更新策略说明：</p>
<ul>
<li>在deployment的定义中，可以通过spec.strategy指定pod更新策略，重建(Recreate)和滚动更新(RollingUpdate),默认为RollingUpdate</li>
<li>spec.strategy.rollingUpdate.maxUnavilable 指定deployment在更新过程中不可用状态的Pod数量的上限</li>
<li>spec.strategy.rollingUpdate.maxSurge 指定在deployment更新pod的过程中pod总数超过pod期望副本数部分的最大值</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"># 查看deployment部署记录</div><div class="line">kubectl rollout history deployment/nginx-deployment</div><div class="line"> </div><div class="line"># 回滚到上一个部署版本</div><div class="line">kubectl rollout undo deployment/nginx-deployment</div><div class="line">或者</div><div class="line">kubectl rollout undo deployment/nginx-deployment --to-revision=2 # 回滚到之前稳定版本</div></pre></td></tr></table></figure>
<h4 id="暂停和恢复Deployment部署"><a href="#暂停和恢复Deployment部署" class="headerlink" title="暂停和恢复Deployment部署"></a>暂停和恢复Deployment部署</h4><p>复杂的deployment配置修改，可以先暂停deployment的更新操作，然后进行配置修改，在恢复deployment，一次性触发完整的更新操作<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"># 暂停deployment更新操作</div><div class="line">kubectl rollout pause deployment/nginx-deployment</div><div class="line"># 修改更新操作</div><div class="line"># 恢复deployment更新</div><div class="line">kubectl rollout resume deploy nginx-deployment</div></pre></td></tr></table></figure></p>
<h3 id="Pod的扩缩容"><a href="#Pod的扩缩容" class="headerlink" title="Pod的扩缩容"></a>Pod的扩缩容</h3><h4 id="手动扩缩容机制"><a href="#手动扩缩容机制" class="headerlink" title="手动扩缩容机制"></a>手动扩缩容机制</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">kubectl scale deployment nginx-deployment --replicas=5</div></pre></td></tr></table></figure>
<h3 id="ConfigMap"><a href="#ConfigMap" class="headerlink" title="ConfigMap"></a>ConfigMap</h3><h4 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h4><ul>
<li>通过环境变量获取configmp的内容</li>
<li>通过volume挂载的方式将configmap中的内容挂载为容器内部的文件或目录</li>
<li>设置容器启动命令的启动参数(引用环境变量)</li>
</ul>
<h4 id="定义方式"><a href="#定义方式" class="headerlink" title="定义方式"></a>定义方式</h4><ul>
<li><p>yaml配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">apiVersion: v1</div><div class="line">kind: ConfigMap</div><div class="line">metadata:</div><div class="line">  name: cm-demo</div><div class="line">data:</div><div class="line">  loglevel: info</div><div class="line">  datadir: /data/www</div></pre></td></tr></table></figure>
</li>
<li><p>通过命令行方式创建</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"># 直接指定k-v</div><div class="line">kubectl create configmap NAME --from-literal=key=value</div><div class="line"># 通过目录/文件创建</div><div class="line">kubectl create config NAME --from-file=config-dir or config-file</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="使用方式"><a href="#使用方式" class="headerlink" title="使用方式"></a>使用方式</h4><ul>
<li><p>环境变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">env:</div><div class="line">- name: LOGLEVEL</div><div class="line">  valueFrom:</div><div class="line">    configMapRef</div><div class="line">      name: cm-demo</div><div class="line">      key: loglevel</div><div class="line">或者</div><div class="line">envFrom:</div><div class="line">  - configMapRef</div><div class="line">    name: cm-demo # 根据cm-demo中的kv自动生成环境变量</div></pre></td></tr></table></figure>
</li>
<li><p>volumeMount使用ConfigMap</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">volumeMounts:</div><div class="line">- name: configpath</div><div class="line">  mountPath: /data/config</div><div class="line"></div><div class="line">volumes:</div><div class="line">- name: configpath</div><div class="line">  configMap:</div><div class="line">    # 如果不指定items，则每个item都会生成一个文件名为key的文件</div><div class="line">    name: cm-demo</div><div class="line">    items:</div><div class="line">    - key: serverxml</div><div class="line">      path: server.xml</div></pre></td></tr></table></figure>
</li>
</ul>
<h4 id="ConfigMap的限制条件"><a href="#ConfigMap的限制条件" class="headerlink" title="ConfigMap的限制条件"></a>ConfigMap的限制条件</h4><ul>
<li>configmap必须在pod之前创建</li>
<li>configmap在相同的namespace中的pod使用</li>
<li>configmap中的配额管理还未实现</li>
<li>通过–manifest-url或者–config创建的静态pod无法使用configmap</li>
<li>configmap挂载操作，在容器中只能挂载为目录，不能为文件</li>
</ul>
  
	</div>
		<footer class="article-footer clearfix">

  <div class="article-tags">
  
  <span></span> <a href="/tags/pods/">pods</a>
  </div>


<div class="article-categories">
  <span></span>
  <a class="article-category-link" href="/categories/Kubernetes/">Kubernetes</a>
</div>



<div class="article-share" id="share">

  <div data-url="https://ttxsgoto.github.io/2020/03/20/k8s-pods/" data-title="Kubernetes Pods | ttxsgoto&#39; Blog" data-tsina="null" class="share clearfix">
  </div>

</div>
</footer>   	       
	</article>
	
<nav class="article-nav clearfix">
 
 <div class="prev" >
 <a href="/2020/03/23/k8s-service/" title="Kubernetes Service">
  <strong>新一篇:</strong><br/>
  <span>
  Kubernetes Service</span>
</a>
</div>


<div class="next">
<a href="/2020/03/20/k8s-cluster-install/"  title="Kubernetes 集群部署">
 <strong>旧一篇:</strong><br/> 
 <span>Kubernetes 集群部署
</span>
</a>
</div>

</nav>

	
<section class="comment">
	
	<div class="ds-thread" data-title="Kubernetes Pods" data-thread-key="k8s-pods" data-author-key="ttxsgoto" data-url="https://ttxsgoto.github.io/post/k8s-pods"></div>
	
</section>


</div>  
    </div>
    <footer><div id="footer" >
	<div class="copyright">
		<span>Powered by <a href="https://github.com/hexojs/hexo">Hexo</a> and theme by 
		<a href="https://github.com/levonlin/Tinnypp">Tinnypp</a>.</span>
		
			<span>© ttxsgoto</span>
		
	<div>

<script type="text/javascript">
  (function(w,d,t,u,n,s,e){w['SwiftypeObject']=n;w[n]=w[n]||function(){
  (w[n].q=w[n].q||[]).push(arguments);};s=d.createElement(t);
  e=d.getElementsByTagName(t)[0];s.async=1;s.src=u;e.parentNode.insertBefore(s,e);
  })(window,document,'script','//s.swiftypecdn.com/install/v2/st.js','_st');
  
  _st('install','hZ7WsBNz4sCsnRDfH9NT','2.0.0');
</script>
</div></footer>
    <script src="/js/jquery-2.1.0.min.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  //back to top
  function backToTop(){
    var buttonHTML = $("<a href=\"#top\" id=\"back-top\">" + "<span>Back to Top</span></a>");
    buttonHTML.appendTo($("body"));
    var buttonToTop = $("#back-top");
    // hide #back-top first
    buttonToTop.hide();

    // fade in #back-top
    $(function() {
        $(window).scroll(function() {
            if ($(this).scrollTop() > 200) {
                buttonToTop.fadeIn();
            } else {
                buttonToTop.fadeOut();
            }
        });
        // scroll body to 0px on click
        buttonToTop.click(function() {
            $('body,html').animate({
                scrollTop: 0
            }, 800);
            return false;
        });
    });
  }
  backToTop();

  $('.navbar').click(function(){
    $('header nav').toggleClass('shownav');
  });
  var myWidth = 0;
  function getSize(){
    if( typeof( window.innerWidth ) == 'number' ) {
      myWidth = window.innerWidth;
    } else if( document.documentElement && document.documentElement.clientWidth) {
      myWidth = document.documentElement.clientWidth;
    };
  };
  var m = $('#main'),
      a = $('#asidepart'),
      c = $('.closeaside'),
      ta = $('#toc.toc-aside');
  $(window).resize(function(){
    getSize(); 
    if (myWidth >= 1024) {
      $('header nav').removeClass('shownav');
    }else
    {
      m.removeClass('moveMain');
      a.css('display', 'block').removeClass('fadeOut');
        
    }
  });

  var show = true;
  c.click(function(){
    if(show == true){
        a.addClass('fadeOut').css('display', 'none');
        ta.css('display', 'block').addClass('fadeIn');
        m.addClass('moveMain');  
    }else{
        a.css('display', 'block').removeClass('fadeOut').addClass('fadeIn');     
        ta.css('display', 'none'); 
        m.removeClass('moveMain');
        $('#toc.toc-aside').css('display', 'none');
    }
    show = !show;
  });
});
</script>

<script type="text/javascript">
$(document).ready(function(){ 
  var ai = $('.article-content>iframe'),
      ae = $('.article-content>embed'),
      t  = $('#toc'),
      h  = $('article h2')
      ah = $('article h2'),
      ta = $('#toc.toc-aside'),
      o  = $('.openaside'),
      c  = $('.closeaside');
  if(ai.length>0){
    ai.wrap('<div class="video-container" />');
  };
  if(ae.length>0){
   ae.wrap('<div class="video-container" />');
  };
  if(ah.length==0){
    t.css('display','none');
  }else{

    $(window).scroll(function(){
      ta.css("top",Math.max(140,240-$(this).scrollTop()));
    });
  };
});
</script>


<script type="text/javascript">
$(document).ready(function(){ 
  var $this = $('.share'),
      url = $this.attr('data-url'),
      encodedUrl = encodeURIComponent(url),
      title = $this.attr('data-title'),
      tsina = $this.attr('data-tsina');
  var html = [
  '<a href="#" class="overlay" id="qrcode"></a>',
  '<div class="qrcode clearfix"><span>扫描二维码分享到微信朋友圈</span><a class="qrclose" href="#share"></a><strong>Loading...Please wait</strong><img id="qrcode-pic" data-src="http://s.jiathis.com/qrcode.php?url=' + encodedUrl + '"/></div>',
  '<a href="#textlogo" class="article-back-to-top" title="Top"></a>',
  '<a href="https://www.facebook.com/sharer.php?u=' + encodedUrl + '" class="article-share-facebook" target="_blank" title="Facebook"></a>',
  '<a href="#qrcode" class="article-share-qrcode" title="QRcode"></a>',
  '<a href="https://twitter.com/intent/tweet?url=' + encodedUrl + '" class="article-share-twitter" target="_blank" title="Twitter"></a>',
  '<a href="http://service.weibo.com/share/share.php?title='+title+'&url='+encodedUrl +'&ralateUid='+ tsina +'&searchPic=true&style=number' +'" class="article-share-weibo" target="_blank" title="Weibo"></a>',
  '<span title="Share to"></span>'
  ].join('');
  $this.append(html);
  $('.article-share-qrcode').click(function(){
    var imgSrc = $('#qrcode-pic').attr('data-src');
    $('#qrcode-pic').attr('src', imgSrc);
    $('#qrcode-pic').load(function(){
        $('.qrcode strong').text(' ');
    });
  });
});     
</script>


<script type="text/javascript">
  var duoshuoQuery = {short_name:"null"};
  (function() {
    var ds = document.createElement('script');
    ds.type = 'text/javascript';ds.async = true;
    ds.src = '//static.duoshuo.com/embed.js';    //change to ds.src = '/js/embed.js'; to add useragent for duoshuo
    ds.charset = 'UTF-8';
    (document.getElementsByTagName('head')[0] 
    || document.getElementsByTagName('body')[0]).appendChild(ds);
  })();
</script> 



<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
$(document).ready(function(){ 
  $('.article-content').each(function(i){
    $(this).find('img').each(function(){
      if ($(this).parent().hasClass('fancybox')) return;
      var alt = this.alt;
      if (alt) $(this).after('<span class="caption">' + alt + '</span>');
      $(this).wrap('<a href="' + this.src + '" title="' + alt + '" class="fancybox"></a>');
    });
    $(this).find('.fancybox').each(function(){
      $(this).attr('rel', 'article' + i);
    });
  });
  if($.fancybox){
    $('.fancybox').fancybox();
  }
}); 
</script>

<script type="text/javascript">
  function footerPosition() {
    var contentHeight = document.documentElement.scrollHeight,
        winHeight = window.innerHeight;
    if(contentHeight <= winHeight) {
      $('footer').addClass('fixed-bottom');
    } else {
      $('footer').removeClass('fixed-bottom');
    }
  }
  footerPosition();
  $(window).resize(footerPosition);
</script>


  </body>
</html>
